
name: CI Build & Deploy (Tomcat + JFrog)

on:
  push:
    branches:
      - "feature-1"     # ← runs automatically on pushes to feature-1
  pull_request:
    branches:
      - "feature-1"     # Optional: run on PRs targeting feature-1
  workflow_dispatch:     # Optional: manual runs from Actions tab

permissions:
  contents: read
  id-token: write        # for optional JFrog OIDC, if you choose to use it

env:
  TOMCAT_DIR: /opt/tomcat10/webapps

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # --- Checkout the repo ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # (Optional) If your pom.xml is NOT in repo root, uncomment and set the correct path:
      # - name: Inspect workspace
      #   run: |
      #     pwd
      #     ls -la
      #     find . -maxdepth 3 -name "pom.xml" -print

      # --- Java & Maven setup ---
      - name: Set up Java (Temurin 17) + Maven cache
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven
          # If your pom.xml is not at repo root, set this:
          # cache-dependency-path: "app/pom.xml"

      # --- Build with Maven ---
      - name: Build with Maven
        run: mvn -B clean install
        # If pom.xml is in a subfolder, add:
        # working-directory: app

      # --- Show target folder contents (debugging aid) ---
      - name: Show contents of target/
        run: ls -l target

      # --- Detect built artifact (.war or .jar) ---
      - name: Determine artifact path
        id: artifact
        shell: bash
        run: |
          set -e
          WAR=$(ls target/*.war 2>/dev/null || true)
          JAR=$(ls target/*.jar 2>/dev/null || true)
          if [ -n "$WAR" ]; then
            echo "path=$WAR" >> "$GITHUB_OUTPUT"
            echo "type=war" >> "$GITHUB_OUTPUT"
          elif [ -n "$JAR" ]; then
            echo "path=$JAR" >> "$GITHUB_OUTPUT"
            echo "type=jar" >> "$GITHUB_OUTPUT"
          else
            echo "No WAR or JAR found in target/"
            exit 1
          fi
          echo "Detected artifact: ${WAR}${JAR}"

      # --- JFrog CLI setup (using secrets) ---
      - name: Set up JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          # Add these in Repo Settings → Secrets and variables → Actions
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
        # If you prefer OIDC instead of storing tokens, use:
        # with:
        #   oidc-provider-name: ${{ vars.JF_OIDC_PROVIDER_NAME }}
        # env:
        #   JF_URL: ${{ vars.JF_URL }}

      # --- Upload artifact to Artifactory (time-stamped path, includes branch) ---
      - name: Push artifact to JFrog Artifactory
        env:
          ARTIFACT_PATH: ${{ steps.artifact.outputs.path }}
          BRANCH_NAME: ${{ github.ref_name }}   # should be 'feature-1' for pushes
        run: |
          set -e
          currentDate=$(date +"%Y-%m-%d_%H-%M")
          # Example target path includes branch name; adjust as you like:
          targetPath="news_app1/${BRANCH_NAME}/${currentDate}/"
          echo "Uploading ${ARTIFACT_PATH} to ${targetPath}"
          jf rt upload --fail-no-op "${ARTIFACT_PATH}" "${targetPath}"
          # Publish build-info (workflow name & run number used automatically)
          jf rt build-publish

      # --- Optional local run only for JARs ---
      - name: Run JAR locally (skip if WAR)
        if: steps.artifact.outputs.type == 'jar'
        run: |
          java -jar "${{ steps.artifact.outputs.path }}"

      # --- Prepare SSH (key + known_hosts) for target server ---
      - name: Prepare SSH key and known_hosts
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          TOMCAT_HOST: ${{ secrets.TOMCAT_HOST }}
        run: |
          set -e
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$TOMCAT_HOST" >> ~/.ssh/known_hosts

      # --- Copy artifact to Tomcat webapps ---
      - name: Copy artifact to Tomcat
        env:
          TOMCAT_HOST: ${{ secrets.TOMCAT_HOST }}
          TOMCAT_USER: ${{ secrets.TOMCAT_USER }}
          TOMCAT_DIR: ${{ secrets.TOMCAT_DIR }}
          ARTIFACT_PATH: ${{ steps.artifact.outputs.path }}
        run: |
          scp -i ~/.ssh/deploy_key "${ARTIFACT_PATH}" "${TOMCAT_USER}@${TOMCAT_HOST}:${TOMCAT_DIR}/"

      # --- Restart Tomcat ---
      - name: Restart Tomcat remotely
        env:
          TOMCAT_HOST: ${{ secrets.TOMCAT_HOST }}
          TOMCAT_USER: ${{ secrets.TOMCAT_USER }}
        run: |
          # If restart-tomcat.sh exists in repo, copy & run it; else try common service names
          if [ -f ./restart-tomcat.sh ]; then
            scp -i ~/.ssh/deploy_key ./restart-tomcat.sh "${TOMCAT_USER}@${TOMCAT_HOST}:~/restart-tomcat.sh"
            ssh -i ~/.ssh/deploy_key "${TOMCAT_USER}@${TOMCAT_HOST}" 'bash ~/restart-tomcat.sh'
          else
            ssh -i ~/.ssh/deploy_key "${TOMCAT_USER}@${TOMCAT_HOST}" 'sudo systemctl restart tomcat || sudo systemctl restart tomcat10 || sudo service tomcat restart'
          fi
